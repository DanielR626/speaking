<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>At the Airport - Speaking Exercise B1</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        
        h1 {
            text-align: center;
            color: #667eea;
            font-size: 2.5rem;
            margin-bottom: 10px;
        }
        
        .subtitle {
            text-align: center;
            color: #666;
            font-size: 1.1rem;
            margin-bottom: 30px;
        }
        
        .progress {
            background: #e0e0e0;
            border-radius: 10px;
            height: 30px;
            margin-bottom: 30px;
            overflow: hidden;
        }
        
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
        }
        
        .video-container {
            margin: 30px 0;
            border-radius: 15px;
            overflow: hidden;
        }
        
        .video-container iframe {
            width: 100%;
            height: 450px;
        }
        
        .question {
            background: #f7f9fc;
            border: 3px solid #e0e0e0;
            border-radius: 15px;
            padding: 25px;
            margin: 20px 0;
            transition: all 0.3s ease;
        }
        
        .question.active {
            border-color: #667eea;
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.3);
        }
        
        .question.completed {
            border-color: #4caf50;
            background: #f0f8f0;
        }
        
        .question.locked {
            opacity: 0.5;
            pointer-events: none;
        }
        
        .question-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .question-number {
            background: #667eea;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;
            font-size: 1.2rem;
        }
        
        .question.completed .question-number {
            background: #4caf50;
        }
        
        .question-text {
            flex: 1;
            font-size: 1.2rem;
            font-weight: 600;
            color: #333;
        }
        
        .record-btn {
            background: linear-gradient(135deg, #4caf50, #45a049);
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 50px;
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 10px;
        }
        
        .record-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(76, 175, 80, 0.4);
        }
        
        .record-btn.recording {
            background: linear-gradient(135deg, #f44336, #d32f2f);
            animation: pulse 1s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        .status {
            margin: 15px 0;
            font-size: 1rem;
            color: #666;
            font-weight: 500;
        }
        
        .result-area {
            margin-top: 20px;
            display: none;
        }
        
        .result-area.show {
            display: block;
        }
        
        .audio-player {
            width: 100%;
            margin: 15px 0;
        }
        
        .transcription-label {
            font-size: 1.1rem;
            font-weight: 700;
            color: #667eea;
            margin: 20px 0 10px 0;
        }
        
        .transcription-box {
            background: #fff;
            border: 3px solid #667eea;
            border-radius: 15px;
            padding: 20px;
            font-size: 1.2rem;
            line-height: 1.8;
            color: #333;
            font-weight: 600;
            min-height: 80px;
        }
        
        .validation-result {
            margin-top: 20px;
            padding: 25px;
            border-radius: 15px;
            display: none;
        }
        
        .validation-result.show {
            display: block;
        }
        
        .validation-result.correct {
            background: #d4edda;
            border: 3px solid #4caf50;
        }
        
        .validation-result.incorrect {
            background: #f8d7da;
            border: 3px solid #f44336;
        }
        
        .validation-icon {
            font-size: 3rem;
            margin-bottom: 10px;
        }
        
        .validation-message {
            font-size: 1.3rem;
            font-weight: 700;
            margin-bottom: 10px;
        }
        
        .validation-result.correct .validation-message {
            color: #155724;
        }
        
        .validation-result.incorrect .validation-message {
            color: #721c24;
        }
        
        .hint {
            margin-top: 15px;
            font-size: 1rem;
            line-height: 1.6;
            color: #666;
        }
        
        .continue-btn, .retry-btn {
            margin-top: 20px;
            padding: 15px 40px;
            border: none;
            border-radius: 50px;
            font-size: 1.2rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .continue-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }
        
        .continue-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .retry-btn {
            background: linear-gradient(135deg, #ff9800, #f57c00);
            color: white;
        }
        
        .retry-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 152, 0, 0.4);
        }
        
        .completion-box {
            background: linear-gradient(135deg, #d4edda, #c3e6cb);
            border: 3px solid #4caf50;
            border-radius: 15px;
            padding: 30px;
            text-align: center;
            margin-top: 30px;
            display: none;
        }
        
        .completion-box.show {
            display: block;
        }
        
        .completion-box h2 {
            color: #155724;
            font-size: 2rem;
            margin-bottom: 15px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>‚úàÔ∏è At the Airport Conversation</h1>
        <p class="subtitle">Speaking Practice - Level B1</p>
        
        <div class="progress">
            <div class="progress-bar" id="progressBar" style="width: 0%;">
                <span id="progressText">0/5 Complete</span>
            </div>
        </div>
        
        <h2 style="margin: 30px 0 15px 0; color: #333;">üì∫ Step 1: Watch the Video</h2>
        <div class="video-container">
            <iframe src="https://www.youtube.com/embed/V8CvxE9fBXs" allowfullscreen></iframe>
        </div>
        
        <h2 style="margin: 30px 0 15px 0; color: #333;">üé§ Step 2: Answer the Questions</h2>
        <p style="color: #666; margin-bottom: 20px;">Record your answer for each question. You must answer correctly to continue!</p>
        
        <!-- Question 1 -->
        <div class="question active" data-q="1">
            <div class="question-header">
                <div class="question-number">1</div>
                <div class="question-text">Why is the girl worried?</div>
            </div>
            <button class="record-btn" onclick="toggleRecording(1)">
                <span id="icon-1">üéôÔ∏è</span>
                <span id="btnText-1">Start Recording</span>
            </button>
            <div class="status" id="status-1">Click to start recording</div>
            
            <div class="result-area" id="result-1">
                <audio class="audio-player" id="audio-1" controls></audio>
                <div class="transcription-label">üìù What you said:</div>
                <div class="transcription-box" id="trans-1">Processing...</div>
                
                <div class="validation-result" id="validation-1">
                    <div class="validation-icon" id="icon-val-1"></div>
                    <div class="validation-message" id="msg-1"></div>
                    <div class="hint" id="hint-1"></div>
                    <button class="continue-btn" id="continue-1" onclick="goNext(1)" style="display:none;">Continue to Question 2 ‚Üí</button>
                    <button class="retry-btn" id="retry-1" onclick="resetQuestion(1)" style="display:none;">Try Again üîÑ</button>
                </div>
            </div>
        </div>
        
        <!-- Question 2 -->
        <div class="question locked" data-q="2">
            <div class="question-header">
                <div class="question-number">2</div>
                <div class="question-text">Where did she lose the passport?</div>
            </div>
            <button class="record-btn" onclick="toggleRecording(2)">
                <span id="icon-2">üéôÔ∏è</span>
                <span id="btnText-2">Start Recording</span>
            </button>
            <div class="status" id="status-2">Click to start recording</div>
            
            <div class="result-area" id="result-2">
                <audio class="audio-player" id="audio-2" controls></audio>
                <div class="transcription-label">üìù What you said:</div>
                <div class="transcription-box" id="trans-2">Processing...</div>
                
                <div class="validation-result" id="validation-2">
                    <div class="validation-icon" id="icon-val-2"></div>
                    <div class="validation-message" id="msg-2"></div>
                    <div class="hint" id="hint-2"></div>
                    <button class="continue-btn" id="continue-2" onclick="goNext(2)" style="display:none;">Continue to Question 3 ‚Üí</button>
                    <button class="retry-btn" id="retry-2" onclick="resetQuestion(2)" style="display:none;">Try Again üîÑ</button>
                </div>
            </div>
        </div>
        
        <!-- Question 3 -->
        <div class="question locked" data-q="3">
            <div class="question-header">
                <div class="question-number">3</div>
                <div class="question-text">What does the boy suggest to her?</div>
            </div>
            <button class="record-btn" onclick="toggleRecording(3)">
                <span id="icon-3">üéôÔ∏è</span>
                <span id="btnText-3">Start Recording</span>
            </button>
            <div class="status" id="status-3">Click to start recording</div>
            
            <div class="result-area" id="result-3">
                <audio class="audio-player" id="audio-3" controls></audio>
                <div class="transcription-label">üìù What you said:</div>
                <div class="transcription-box" id="trans-3">Processing...</div>
                
                <div class="validation-result" id="validation-3">
                    <div class="validation-icon" id="icon-val-3"></div>
                    <div class="validation-message" id="msg-3"></div>
                    <div class="hint" id="hint-3"></div>
                    <button class="continue-btn" id="continue-3" onclick="goNext(3)" style="display:none;">Continue to Question 4 ‚Üí</button>
                    <button class="retry-btn" id="retry-3" onclick="resetQuestion(3)" style="display:none;">Try Again üîÑ</button>
                </div>
            </div>
        </div>
        
        <!-- Question 4 -->
        <div class="question locked" data-q="4">
            <div class="question-header">
                <div class="question-number">4</div>
                <div class="question-text">Where are they at that moment?</div>
            </div>
            <button class="record-btn" onclick="toggleRecording(4)">
                <span id="icon-4">üéôÔ∏è</span>
                <span id="btnText-4">Start Recording</span>
            </button>
            <div class="status" id="status-4">Click to start recording</div>
            
            <div class="result-area" id="result-4">
                <audio class="audio-player" id="audio-4" controls></audio>
                <div class="transcription-label">üìù What you said:</div>
                <div class="transcription-box" id="trans-4">Processing...</div>
                
                <div class="validation-result" id="validation-4">
                    <div class="validation-icon" id="icon-val-4"></div>
                    <div class="validation-message" id="msg-4"></div>
                    <div class="hint" id="hint-4"></div>
                    <button class="continue-btn" id="continue-4" onclick="goNext(4)" style="display:none;">Continue to Question 5 ‚Üí</button>
                    <button class="retry-btn" id="retry-4" onclick="resetQuestion(4)" style="display:none;">Try Again üîÑ</button>
                </div>
            </div>
        </div>
        
        <!-- Question 5 -->
        <div class="question locked" data-q="5">
            <div class="question-header">
                <div class="question-number">5</div>
                <div class="question-text">Have you had a similar experience? Tell us about it.</div>
            </div>
            <button class="record-btn" onclick="toggleRecording(5)">
                <span id="icon-5">üéôÔ∏è</span>
                <span id="btnText-5">Start Recording</span>
            </button>
            <div class="status" id="status-5">Click to start recording</div>
            
            <div class="result-area" id="result-5">
                <audio class="audio-player" id="audio-5" controls></audio>
                <div class="transcription-label">üìù What you said:</div>
                <div class="transcription-box" id="trans-5">Processing...</div>
                
                <div class="validation-result" id="validation-5">
                    <div class="validation-icon" id="icon-val-5"></div>
                    <div class="validation-message" id="msg-5"></div>
                    <div class="hint" id="hint-5"></div>
                    <button class="continue-btn" id="continue-5" onclick="showCompletion()" style="display:none;">Finish Exercise ‚úì</button>
                    <button class="retry-btn" id="retry-5" onclick="resetQuestion(5)" style="display:none;">Try Again üîÑ</button>
                </div>
            </div>
        </div>
        
        <div class="completion-box" id="completionBox">
            <h2>üéâ Congratulations!</h2>
            <p style="font-size: 1.2rem; color: #155724;">You've successfully completed all 5 questions!</p>
        </div>
    </div>

    <script>
        const API_URL = 'https://speaking-api-81bp.vercel.app/api/transcribe';
        
        const expectedAnswers = {
            1: {
                keywords: ['lost', 'passport', 'cant', 'find', 'missing', 'lose'],
                hint: 'üí° Hint: According to the video, the girl is worried because she can\'t find her passport. She lost it.'
            },
            2: {
                keywords: ['taxi', 'cab', 'car'],
                hint: 'üí° Hint: According to the video, she thinks she left her passport in the taxi.'
            },
            3: {
                keywords: ['call', 'taxi', 'driver', 'phone', 'contact', 'ring'],
                hint: 'üí° Hint: According to the video, the boy suggests to call the taxi driver.'
            },
            4: {
                keywords: ['airport'],
                hint: 'üí° Hint: According to the video, they are at the airport.'
            },
            5: {
                keywords: [],
                minWords: 10,
                hint: 'üí° This is a personal question. Share your own experience about losing something important. Speak for at least 5-10 seconds.'
            }
        };
        
        let isRecording = {};
        let mediaRecorders = {};
        let audioChunks = {};
        let stream = null;
        let completedCount = 0;
        
        async function toggleRecording(q) {
            if (!isRecording[q]) {
                // START RECORDING
                try {
                    if (!stream) {
                        stream = await navigator.mediaDevices.getUserMedia({audio: true});
                    }
                    
                    audioChunks[q] = [];
                    
                    let mimeType = MediaRecorder.isTypeSupported('audio/mp4') ? 'audio/mp4' : 
                                   MediaRecorder.isTypeSupported('audio/webm;codecs=opus') ? 'audio/webm;codecs=opus' : 'audio/webm';
                    
                    const recorder = new MediaRecorder(stream, { mimeType });
                    mediaRecorders[q] = recorder;
                    
                    recorder.ondataavailable = e => {
                        if (e.data.size > 0) audioChunks[q].push(e.data);
                    };
                    
                    recorder.onstop = async () => {
                        const blob = new Blob(audioChunks[q], {type: mimeType});
                        const url = URL.createObjectURL(blob);
                        document.getElementById('audio-' + q).src = url;
                        document.getElementById('result-' + q).classList.add('show');
                        await transcribeAudio(blob, q);
                    };
                    
                    recorder.start(200);
                    isRecording[q] = true;
                    
                    document.getElementById('btnText-' + q).textContent = 'Stop Recording';
                    document.querySelector('[onclick="toggleRecording(' + q + ')"]').classList.add('recording');
                    document.getElementById('status-' + q).textContent = 'üî¥ Recording... Speak clearly!';
                    
                } catch(err) {
                    document.getElementById('status-' + q).textContent = '‚ùå Microphone error: ' + err.message;
                }
            } else {
                // STOP RECORDING
                isRecording[q] = false;
                if (mediaRecorders[q]) {
                    mediaRecorders[q].stop();
                }
                document.getElementById('btnText-' + q).textContent = 'Processing...';
                document.querySelector('[onclick="toggleRecording(' + q + ')"]').classList.remove('recording');
                document.getElementById('status-' + q).textContent = '‚è≥ Transcribing your audio...';
            }
        }
        
        async function transcribeAudio(blob, q) {
            const transBox = document.getElementById('trans-' + q);
            transBox.textContent = 'Transcribing...';
            
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/octet-stream'},
                    body: blob
                });
                
                const data = await response.json();
                
                if (data.success && data.text) {
                    // ‚úÖ MOSTRAR LA TRANSCRIPCI√ìN SIEMPRE
                    transBox.textContent = data.text;
                    document.getElementById('status-' + q).textContent = '‚úÖ Transcription complete!';
                    
                    // Validar
                    validateAnswer(q, data.text);
                } else {
                    throw new Error('Transcription failed');
                }
            } catch(err) {
                transBox.textContent = '‚ö†Ô∏è Error: Could not transcribe. Try again.';
                document.getElementById('status-' + q).textContent = '‚ùå Transcription failed';
            } finally {
                document.getElementById('btnText-' + q).textContent = 'Record Again';
            }
        }
        
        function validateAnswer(q, text) {
            const expected = expectedAnswers[q];
            const textLower = text.toLowerCase();
            let isCorrect = false;
            
            if (q === 5) {
                const wordCount = text.trim().split(/\s+/).length;
                isCorrect = wordCount >= 10;
            } else {
                const found = expected.keywords.filter(kw => textLower.includes(kw.toLowerCase()));
                isCorrect = found.length >= 1;
            }
            
            const validation = document.getElementById('validation-' + q);
            validation.classList.add('show');
            
            if (isCorrect) {
                // ‚úÖ CORRECTO
                validation.classList.remove('incorrect');
                validation.classList.add('correct');
                document.getElementById('icon-val-' + q).textContent = '‚úÖ';
                document.getElementById('msg-' + q).textContent = 'Correct! Well done!';
                document.getElementById('hint-' + q).textContent = 'Your answer matches the video content. You can continue!';
                document.getElementById('continue-' + q).style.display = 'inline-block';
                document.getElementById('retry-' + q).style.display = 'none';
                
                document.querySelector('[data-q="' + q + '"]').classList.add('completed');
                document.querySelector('[data-q="' + q + '"]').classList.remove('active');
                
                completedCount++;
                updateProgress();
                
                // Scroll al bot√≥n Continue
                setTimeout(() => {
                    document.getElementById('continue-' + q).scrollIntoView({behavior: 'smooth', block: 'center'});
                }, 300);
                
            } else {
                // ‚ùå INCORRECTO
                validation.classList.remove('correct');
                validation.classList.add('incorrect');
                document.getElementById('icon-val-' + q).textContent = '‚ùå';
                document.getElementById('msg-' + q).textContent = 'Incorrect answer';
                document.getElementById('hint-' + q).innerHTML = expected.hint + '<br><br>Please watch the video again and record your answer.';
                document.getElementById('continue-' + q).style.display = 'none';
                document.getElementById('retry-' + q).style.display = 'inline-block';
            }
        }
        
        function resetQuestion(q) {
            document.getElementById('validation-' + q).classList.remove('show');
            document.getElementById('status-' + q).textContent = 'Ready to record again';
            document.getElementById('btnText-' + q).textContent = 'Start Recording';
        }
        
        function goNext(current) {
            document.querySelector('[data-q="' + current + '"]').classList.remove('active');
            
            if (current < 5) {
                const next = current + 1;
                document.querySelector('[data-q="' + next + '"]').classList.remove('locked');
                document.querySelector('[data-q="' + next + '"]').classList.add('active');
                
                // Scroll a la siguiente pregunta
                setTimeout(() => {
                    document.querySelector('[data-q="' + next + '"]').scrollIntoView({behavior: 'smooth', block: 'start'});
                }, 300);
            }
        }
        
        function showCompletion() {
            document.getElementById('completionBox').classList.add('show');
            document.getElementById('completionBox').scrollIntoView({behavior: 'smooth', block: 'center'});
        }
        
        function updateProgress() {
            const percent = (completedCount / 5) * 100;
            document.getElementById('progressBar').style.width = percent + '%';
            document.getElementById('progressText').textContent = completedCount + '/5 Complete';
        }
    </script>
</body>
</html>
